<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Realtime</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #eef2ff;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --white: #ffffff;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            
            /* Theme variables */
            --bg-color: #f5f7fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --input-bg: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        /* Dark mode styles */
        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #f8f9fa;
            --card-bg: #2d2d2d;
            --sidebar-bg: #252525;
            --input-bg: #3d3d3d;
            --primary-light: #2a3a7a;
            --gray: #aaaaaa;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            transition: var(--transition);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Notification badges */
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .tab-button {
            position: relative; /* For badge positioning */
        }

        /* Header */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .admin-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-header h1 i {
            font-size: 24px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Theme toggle switch */
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: .4s;
            border-radius: 34px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .theme-slider {
            background-color: var(--primary);
        }

        input:checked + .theme-slider:before {
            transform: translateX(30px);
        }

        .theme-icons {
            position: absolute;
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 8px;
            top: 5px;
            pointer-events: none;
        }

        .theme-icons i {
            color: white;
            font-size: 14px;
        }

        /* Tabs */
        .tabs-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 16px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            transition: var(--transition);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: var(--primary);
            background: var(--primary-light);
        }

        .tab-button.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }

        .tab-button i {
            font-size: 16px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .card-description {
            font-size: 14px;
            color: var(--gray);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Charts */
        .chart-container {
            width: 100%;
            max-width: 800px;
            height: 350px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin: 0 auto 30px auto;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
            text-align: center;
        }

        /* D3.js specific bar styling */
        .bar {
            fill: var(--primary);
            transition: fill 0.3s ease;
        }
        .bar:hover {
            fill: var(--secondary);
        }
        .bar.status-approved { fill: var(--success); }
        .bar.status-pending { fill: var(--warning); }
        .bar.status-rejected { fill: var(--danger); }

        .axis-label {
            font-size: 0.9em;
            fill: var(--gray);
        }
        .axis line, .axis path {
            stroke: var(--border-color);
        }
        .axis text {
            fill: var(--gray);
            font-size: 0.8em;
        }
        .grid line {
            stroke: var(--border-color);
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }

        /* Tables */
        .table-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 15px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
            color: var(--text-color);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-pending {
            background: rgba(248, 150, 30, 0.1);
            color: var(--warning);
        }

        .badge-approved {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .badge-rejected {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        .badge-active {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        .badge-inactive {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }
        .badge-outofstock {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #3ab7d8;
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #e5177a;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #e68a1b;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray);
            color: var(--gray);
        }

        .btn-outline:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            background: var(--input-bg);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Messages */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alert.active {
            display: flex;
            opacity: 1;
        }

        .alert-success {
            background: rgba(76, 201, 240, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Chat */
        .chat-container {
            display: flex;
            height: 600px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .chat-sidebar {
            width: 300px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            background: var(--sidebar-bg);
        }

        .chat-user {
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-user:hover {
            background: var(--primary-light);
        }

        .chat-user.active {
            background: var(--primary-light);
            border-left: 3px solid var(--primary);
        }

        .chat-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--text-color);
        }

        .chat-user-email {
            font-size: 12px;
            color: var(--gray);
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .chat-message-user {
            align-self: flex-start;
            background: rgba(0, 0, 0, 0.05);
            border-bottom-left-radius: 4px;
            color: var(--text-color);
        }

        .chat-message-admin {
            align-self: flex-end;
            background: var(--primary);
            color: var(--white);
            border-bottom-right-radius: 4px;
        }

        .chat-message-time {
            font-size: 11px;
            color: var(--gray);
            margin-top: 5px;
            text-align: right;
        }

        .chat-message-admin .chat-message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chat-send-btn {
            padding: 0 20px;
            border-radius: var(--border-radius);
            background: var(--primary);
            color: var(--white);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .chat-send-btn:hover {
            background: var(--secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .chat-container {
                height: 500px;
            }
            
            .chat-sidebar {
                width: 250px;
            }
        }

        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }
            .chart-container {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab-button {
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .admin-actions {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1><i class="fas fa-cog"></i> Admin Dashboard</h1>
            <div class="admin-actions">
                <button class="btn btn-outline" onclick="refreshDashboard()"><i class="fas fa-sync-alt"></i> Refresh</button>
                
                <label class="theme-toggle">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="theme-slider"></span>
                    <div class="theme-icons">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                    </div>
                </label>
                
                <button class="btn btn-primary" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'Dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                    <span class="badge-count" id="dashboard-badge" style="display: none;">0</span>
                </button>
                <button class="tab-button" onclick="openTab(event, 'Users')">
                    <i class="fas fa-users"></i> Users
                    <span class="badge-count" id="users-badge" style="display: none;">0</span>
                </button>
                <button class="tab-button" onclick="openTab(event, 'Products')">
                    <i class="fas fa-boxes"></i> Products
                </button>
                <button class="tab-button" onclick="openTab(event, 'Announcements')">
                    <i class="fas fa-bullhorn"></i> Announcements
                </button>
                <button class="tab-button" onclick="openTab(event, 'Requests')">
                    <i class="fas fa-exchange-alt"></i> Requests
                    <span class="badge-count" id="requests-badge" style="display: none;">0</span>
                </button>
                <button class="tab-button" onclick="openTab(event, 'Chat')">
                    <i class="fas fa-comments"></i> Chat
                    <span class="badge-count" id="chat-badge" style="display: none;">0</span>
                </button>
                <button class="tab-button" onclick="openTab(event, 'Settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="Dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Total Users</h3>
                            <div class="card-icon" style="background: rgba(67, 97, 238, 0.1); color: var(--primary);">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="total-users">0</div>
                        <div class="card-description">Registered Accounts</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Active Users</h3>
                            <div class="card-icon" style="background: rgba(76, 201, 240, 0.1); color: var(--success);">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="card-value" id="active-users">0</div>
                        <div class="card-description">Currently Active</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pending Users</h3>
                            <div class="card-icon" style="background: rgba(248, 150, 30, 0.1); color: var(--warning);">
                                <i class="fas fa-user-clock"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pending-users">0</div>
                        <div class="card-description">Accounts Awaiting Review</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Revenue (Approved Recharges)</h3>
                            <div class="card-icon" style="background: rgba(247, 37, 133, 0.1); color: var(--danger);">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                        </div>
                        <div class="card-value" id="revenue-generated">₹0.00</div>
                        <div class="card-description">Total from Approved Recharges</div>
                    </div>

                     <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pending Recharges</h3>
                            <div class="card-icon" style="background: rgba(248, 150, 30, 0.1); color: var(--warning);">
                                <i class="fas fa-credit-card"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pending-recharge-requests">0</div>
                        <div class="card-description">Awaiting Approval</div>
                    </div>

                     <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pending Purchases</h3>
                            <div class="card-icon" style="background: rgba(248, 150, 30, 0.1); color: var(--warning);">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pending-purchase-requests">0</div>
                        <div class="card-description">Awaiting Fulfillment</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">User Status Distribution</h3>
                    <div id="user-status-chart"></div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Recharge Request Status</h3>
                    <div id="recharge-status-chart"></div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">Purchase Request Status</h3>
                    <div id="purchase-status-chart"></div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="Users" class="tab-content">
                <div class="alert alert-success" id="user-list-alert"></div>
                <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openAddUserModal()">
                    <i class="fas fa-plus"></i> Add New User
                </button>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body">
                                <tr><td colspan="7">Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="Products" class="tab-content">
                <div class="alert alert-success" id="product-list-alert"></div>
                <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i> Add New Product
                </button>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="product-table-body">
                                <tr><td colspan="7">Loading products...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Announcements Tab -->
            <div id="Announcements" class="tab-content">
                <div class="alert alert-success" id="announcement-list-alert"></div>
                <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="openAddAnnouncementModal()">
                    <i class="fas fa-plus"></i> Create New Announcement
                </button>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Content</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="announcement-table-body">
                                <tr><td colspan="5">Loading announcements...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div id="Requests" class="tab-content">
                <h3 class="chart-title" style="text-align: left; margin-bottom: 20px;">Recharge Requests</h3>
                <div class="alert alert-success" id="recharge-requests-alert"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User Email</th>
                                    <th>Amount</th>
                                    <th>Transaction ID</th>
                                    <th>Screenshot</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recharge-requests-table-body">
                                <tr><td colspan="8">Loading recharge requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3 class="chart-title" style="text-align: left; margin-top: 30px; margin-bottom: 20px;">Purchase Requests</h3>
                <div class="alert alert-success" id="purchase-requests-alert"></div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User Email</th>
                                    <th>Product Name</th>
                                    <th>Price</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchase-requests-table-body">
                                <tr><td colspan="7">Loading purchase requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="Chat" class="tab-content">
                <div class="alert alert-success" id="chat-alert"></div>
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <p style="padding: 15px; color: var(--gray); text-align: center;">Select a user to chat</p>
                        <div id="chat-user-list">
                            <!-- User list will be loaded here -->
                        </div>
                    </div>
                    <div class="chat-main">
                        <div class="chat-header" id="chat-header">
                            <i class="fas fa-user"></i> Select a user to start chatting
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <!-- Chat messages will be loaded here -->
                        </div>
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Type your message..." disabled onkeypress="handleChatInput(event)">
                            <button class="chat-send-btn" id="send-chat-btn" disabled onclick="sendAdminMessage()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="Settings" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Admin Settings</h3>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="form-group">
                                <label for="admin-email" class="form-label">Admin Email</label>
                                <input type="email" id="admin-email" class="form-control" value="helpingai2.o@gmail.com" disabled>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-admin-password" class="form-label">Change Password</label>
                                <input type="password" id="new-admin-password" class="form-control" placeholder="New password">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-admin-password" class="form-label">Confirm Password</label>
                                <input type="password" id="confirm-admin-password" class="form-control" placeholder="Confirm new password">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Data Management</label>
                                <div class="btn-group" style="width: 100%;">
                                    <button type="button" class="btn btn-danger" onclick="confirmDeleteAllRequests()">
                                        <i class="fas fa-trash"></i> Delete All Requests
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="confirmDeleteAllPurchases()">
                                        <i class="fas fa-trash"></i> Delete All Purchases
                                    </button>
                                </div>
                                <small class="text-muted" style="color: var(--gray);">Warning: These actions cannot be undone</small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="add-user-alert"></div>
                <div class="form-group">
                    <label for="new-user-name" class="form-label">Name:</label>
                    <input type="text" id="new-user-name" class="form-control" placeholder="Enter user's name" required>
                </div>
                <div class="form-group">
                    <label for="new-user-email" class="form-label">Email:</label>
                    <input type="email" id="new-user-email" class="form-control" placeholder="Enter user's email" required>
                </div>
                <div class="form-group">
                    <label for="new-user-password" class="form-label">Password:</label>
                    <input type="password" id="new-user-password" class="form-control" placeholder="Set a password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleAddUser()">Add User</button>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="edit-user-alert"></div>
                <input type="hidden" id="edit-user-original-email">
                <div class="form-group">
                    <label for="edit-user-name" class="form-label">Name:</label>
                    <input type="text" id="edit-user-name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-user-email" class="form-label">Email:</label>
                    <input type="email" id="edit-user-email" class="form-control" disabled>
                </div>
                <div class="form-group">
                    <label for="edit-user-balance" class="form-label">Balance:</label>
                    <input type="number" id="edit-user-balance" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="edit-user-is-active" class="form-label">Active Status:</label>
                    <select id="edit-user-is-active" class="form-control">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-user-pending" class="form-label">Pending Status:</label>
                    <select id="edit-user-pending" class="form-control">
                        <option value="true">Pending</option>
                        <option value="false">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-user-notes" class="form-label">Notes:</label>
                    <textarea id="edit-user-notes" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleUpdateUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Product</h3>
                <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="add-product-alert"></div>
                <div class="form-group">
                    <label for="product-name" class="form-label">Product Name:</label>
                    <input type="text" id="product-name" class="form-control" placeholder="Enter product name" required>
                </div>
                <div class="form-group">
                    <label for="product-description" class="form-label">Description:</label>
                    <textarea id="product-description" class="form-control" placeholder="Enter product description"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-price" class="form-label">Price (₹):</label>
                    <input type="number" id="product-price" class="form-control" step="0.01" value="0.00" required>
                </div>
                <div class="form-group">
                    <label for="product-discount-price" class="form-label">Discount Price (₹, Optional):</label>
                    <input type="number" id="product-discount-price" class="form-control" step="0.01" placeholder="Optional discount price">
                </div>
                <div class="form-group">
                    <label for="product-image-url" class="form-label">Image URL:</label>
                    <input type="url" id="product-image-url" class="form-control" placeholder="Enter image URL">
                </div>
                <div class="form-group">
                    <label for="product-rating" class="form-label">Rating (0-5):</label>
                    <input type="number" id="product-rating" class="form-control" step="0.1" min="0" max="5" value="0">
                </div>
                <div class="form-group">
                    <label for="product-tags" class="form-label">Tags (comma-separated):</label>
                    <input type="text" id="product-tags" class="form-control" placeholder="e.g., electronics, gadget, new">
                </div>
                <div class="form-group">
                    <label for="product-category" class="form-label">Category:</label>
                    <input type="text" id="product-category" class="form-control" placeholder="e.g., Mobile, Laptop, Home Appliance">
                </div>
                <div class="form-group">
                    <label for="product-stock" class="form-label">Stock Quantity (-1 for unlimited):</label>
                    <input type="number" id="product-stock" class="form-control" value="0" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addProductModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleAddProduct()">Add Product</button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Product</h3>
                <button class="modal-close" onclick="closeModal('editProductModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="edit-product-alert"></div>
                <input type="hidden" id="edit-product-id">
                <div class="form-group">
                    <label for="edit-product-name" class="form-label">Product Name:</label>
                    <input type="text" id="edit-product-name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-product-description" class="form-label">Description:</label>
                    <textarea id="edit-product-description" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-product-price" class="form-label">Price (₹):</label>
                    <input type="number" id="edit-product-price" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="edit-product-discount-price" class="form-label">Discount Price (₹, Optional):</label>
                    <input type="number" id="edit-product-discount-price" class="form-control" step="0.01">
                </div>
                <div class="form-group">
                    <label for="edit-product-image-url" class="form-label">Image URL:</label>
                    <input type="url" id="edit-product-image-url" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-product-rating" class="form-label">Rating (0-5):</label>
                    <input type="number" id="edit-product-rating" class="form-control" step="0.1" min="0" max="5">
                </div>
                <div class="form-group">
                    <label for="edit-product-tags" class="form-label">Tags (comma-separated):</label>
                    <input type="text" id="edit-product-tags" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-product-category" class="form-label">Category:</label>
                    <input type="text" id="edit-product-category" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-product-stock" class="form-label">Stock Quantity (-1 for unlimited):</label>
                    <input type="number" id="edit-product-stock" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editProductModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleUpdateProduct()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Announcement Modal -->
    <div class="modal" id="addAnnouncementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Announcement</h3>
                <button class="modal-close" onclick="closeModal('addAnnouncementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="add-announcement-alert"></div>
                <div class="form-group">
                    <label for="announcement-title" class="form-label">Title:</label>
                    <input type="text" id="announcement-title" class="form-control" placeholder="Enter announcement title" required>
                </div>
                <div class="form-group">
                    <label for="announcement-content" class="form-label">Content:</label>
                    <textarea id="announcement-content" class="form-control" placeholder="Enter announcement content" rows="5" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addAnnouncementModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleAddAnnouncement()">Add Announcement</button>
            </div>
        </div>
    </div>

    <!-- Edit Announcement Modal -->
    <div class="modal" id="editAnnouncementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Announcement</h3>
                <button class="modal-close" onclick="closeModal('editAnnouncementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="edit-announcement-alert"></div>
                <input type="hidden" id="edit-announcement-id">
                <div class="form-group">
                    <label for="edit-announcement-title" class="form-label">Title:</label>
                    <input type="text" id="edit-announcement-title" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-announcement-content" class="form-label">Content:</label>
                    <textarea id="edit-announcement-content" class="form-control" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editAnnouncementModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleUpdateAnnouncement()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Admin Notes Modal for Requests -->
    <div class="modal" id="adminNotesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="notes-modal-title">Add Admin Notes</h3>
                <button class="modal-close" onclick="closeModal('adminNotesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert" id="admin-notes-alert"></div>
                <div class="form-group">
                    <label for="admin-notes-textarea" class="form-label">Notes:</label>
                    <textarea id="admin-notes-textarea" class="form-control" rows="5" placeholder="Enter notes for this request"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('adminNotesModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAdminNotes()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="deleteModalTitle">Confirm Deletion</h3>
                <button class="modal-close" onclick="closeModal('confirmDeleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete all requests? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('confirmDeleteModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration for the admin email
        const ADMIN_EMAIL = "helpingai2.o@gmail.com"; // Set your admin email here

        // Global variables
        let currentChatUserEmail = null;
        let chatRefreshIntervalId = null;
        let pendingRequestsCount = 0;
        let pendingChatsCount = 0;
        let deleteAction = ''; // To store which delete action is pending

        // Theme management
        function applyTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('adminTheme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('adminTheme', 'light');
            }
        }

        function toggleTheme() {
            const isDark = document.getElementById('themeToggle').checked;
            applyTheme(isDark);
        }

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('adminTheme') || 'light';
            const isDark = savedTheme === 'dark';
            document.getElementById('themeToggle').checked = isDark;
            applyTheme(isDark);
        }

        // Notification badges
        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateAllBadges() {
            updateBadge('dashboard-badge', pendingRequestsCount + pendingChatsCount);
            updateBadge('requests-badge', pendingRequestsCount);
            updateBadge('chat-badge', pendingChatsCount);
        }

        // Delete confirmation modals
        function confirmDeleteAllRequests() {
            deleteAction = 'requests';
            document.getElementById('deleteModalTitle').textContent = 'Delete All Requests';
            document.getElementById('deleteModalMessage').textContent = 
                'Are you sure you want to delete ALL requests? This will permanently remove all recharge and purchase requests. This action cannot be undone.';
            document.getElementById('confirmDeleteButton').onclick = executeDeleteAction;
            openModal('confirmDeleteModal');
        }

        function confirmDeleteAllPurchases() {
            deleteAction = 'purchases';
            document.getElementById('deleteModalTitle').textContent = 'Delete All Purchases';
            document.getElementById('deleteModalMessage').textContent = 
                'Are you sure you want to delete ALL purchase records? This will permanently remove all purchase history. This action cannot be undone.';
            document.getElementById('confirmDeleteButton').onclick = executeDeleteAction;
            openModal('confirmDeleteModal');
        }

        function executeDeleteAction() {
            if (deleteAction === 'requests') {
                deleteAllRequests();
            } else if (deleteAction === 'purchases') {
                deleteAllPurchases();
            }
            closeModal('confirmDeleteModal');
        }

        function deleteAllRequests() {
            callAppsScript(
                'deleteAllRequests',
                [],
                function(response) {
                    if (response.success) {
                        showAlert('user-list-alert', 'All requests deleted successfully', true);
                        loadRechargeRequests();
                        loadPurchaseRequests();
                        loadDashboardStats();
                    } else {
                        showAlert('user-list-alert', 'Error deleting requests: ' + response.message, false);
                    }
                },
                function(error) {
                    showAlert('user-list-alert', 'Error deleting requests: ' + error.message, false);
                }
            );
        }

        function deleteAllPurchases() {
            callAppsScript(
                'deleteAllPurchases',
                [],
                function(response) {
                    if (response.success) {
                        showAlert('user-list-alert', 'All purchases deleted successfully', true);
                        loadPurchaseRequests();
                        loadDashboardStats();
                    } else {
                        showAlert('user-list-alert', 'Error deleting purchases: ' + response.message, false);
                    }
                },
                function(error) {
                    showAlert('user-list-alert', 'Error deleting purchases: ' + error.message, false);
                }
            );
        }

        // Enhanced loadDashboardStats with notification counting
        function loadDashboardStats() {
            callAppsScript(
                'getDashboardStats',
                [],
                function(response) {
                    if (response.success && response.stats) {
                        const stats = response.stats;
                        document.getElementById('total-users').textContent = stats.users.total;
                        document.getElementById('active-users').textContent = stats.users.active;
                        document.getElementById('pending-users').textContent = stats.users.pending;
                        document.getElementById('revenue-generated').textContent = formatCurrency(stats.rechargeRequests.revenueGenerated || 0);
                        document.getElementById('pending-recharge-requests').textContent = stats.rechargeRequests.pending;
                        document.getElementById('pending-purchase-requests').textContent = stats.purchaseRequests.pending;

                        drawUserStatusChart(stats.users.active, stats.users.pending);
                        drawRequestStatusChart('recharge-status-chart', stats.rechargeRequests.pending, stats.rechargeRequests.approved, stats.rechargeRequests.rejected);
                        drawRequestStatusChart('purchase-status-chart', stats.purchaseRequests.pending, stats.purchaseRequests.approved, stats.purchaseRequests.rejected);
                        
                        // Update notification badges
                        pendingRequestsCount = 
                            (stats.rechargeRequests.pending || 0) + 
                            (stats.purchaseRequests.pending || 0);
                        pendingChatsCount = stats.unreadChats || 0;
                        
                        updateAllBadges();
                    } else {
                        console.error('Error loading dashboard stats:', response.message);
                        showAlert('user-list-alert', 'Error loading dashboard stats: ' + (response.message || 'Unknown error'), false);
                    }
                },
                function(error) {
                    console.error('RPC Error loading dashboard stats:', error);
                    showAlert('user-list-alert', 'RPC Error loading dashboard stats: ' + error.message, false);
                }
            );
        }

        function drawUserStatusChart(active, pending) {
            const data = [
                { label: 'Active', value: active, statusClass: 'status-approved' },
                { label: 'Pending', value: pending, statusClass: 'status-pending' }
            ];

            const margin = { top: 30, right: 20, bottom: 50, left: 50 };
            const container = d3.select("#user-status-chart");
            const svgWidth = container.node().getBoundingClientRect().width;
            const svgHeight = 300;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            container.select("svg").remove();

            const svg = container
                .append("svg")
                .attr("width", svgWidth)
                .attr("height", svgHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.4);

            const y = d3.scaleLinear()
                .range([height, 0]);

            x.domain(data.map(d => d.label));
            y.domain([0, d3.max(data, d => d.value) * 1.2]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .attr("class", "axis-label");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5).tickSizeOuter(0))
                .selectAll("text")
                .attr("class", "axis-label");

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat("")
                );

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", d => `bar ${d.statusClass}`)
                .attr("x", d => x(d.label))
                .attr("width", x.bandwidth())
                .attr("y", d => y(0))
                .attr("height", 0)
                .transition()
                .duration(800)
                .ease(d3.easeBounceOut)
                .attr("y", d => y(d.value))
                .attr("height", d => height - y(d.value));

            svg.selectAll(".text")
                .data(data)
                .enter().append("text")
                .attr("class", "bar-chart-value")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 10)
                .attr("text-anchor", "middle")
                .style("fill", "#333")
                .style("opacity", 0)
                .text(d => d.value)
                .transition()
                .delay(800)
                .duration(300)
                .style("opacity", 1);
        }

        function drawRequestStatusChart(elementId, pending, approved, rejected) {
            const data = [
                { label: 'Pending', value: pending, statusClass: 'status-pending' },
                { label: 'Approved', value: approved, statusClass: 'status-approved' },
                { label: 'Rejected', value: rejected, statusClass: 'status-rejected' }
            ];

            const margin = { top: 30, right: 20, bottom: 50, left: 50 };
            const container = d3.select(`#${elementId}`);
            const svgWidth = container.node().getBoundingClientRect().width;
            const svgHeight = 300;
            const width = svgWidth - margin.left - margin.right;
            const height = svgHeight - margin.top - margin.bottom;

            container.select("svg").remove();

            const svg = container
                .append("svg")
                .attr("width", svgWidth)
                .attr("height", svgHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.4);

            const y = d3.scaleLinear()
                .range([height, 0]);

            x.domain(data.map(d => d.label));
            y.domain([0, d3.max(data, d => d.value) * 1.2]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .attr("class", "axis-label");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(5).tickSizeOuter(0))
                .selectAll("text")
                .attr("class", "axis-label");

            svg.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(y)
                    .tickSize(-width)
                    .tickFormat("")
                );

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", d => `bar ${d.statusClass}`)
                .attr("x", d => x(d.label))
                .attr("width", x.bandwidth())
                .attr("y", d => y(0))
                .attr("height", 0)
                .transition()
                .duration(800)
                .ease(d3.easeBounceOut)
                .attr("y", d => y(d.value))
                .attr("height", d => height - y(d.value));

            svg.selectAll(".text")
                .data(data)
                .enter().append("text")
                .attr("class", "bar-chart-value")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 10)
                .attr("text-anchor", "middle")
                .style("fill", "#333")
                .style("opacity", 0)
                .text(d => d.value)
                .transition()
                .delay(800)
                .duration(300)
                .style("opacity", 1);
        }

        // --- Helper Functions ---

        /**
         * Calls a Google Apps Script function with success and failure handlers.
         * @param {string} functionName The name of the Apps Script function to call.
         * @param {Array<any>} args An array of arguments to pass to the function.
         * @param {function(any): void} successCallback Function to call on success.
         * @param {function(Error): void} errorCallback Function to call on failure.
         */
        function callAppsScript(functionName, args, successCallback, errorCallback) {
            google.script.run
                .withSuccessHandler(successCallback)
                .withFailureHandler(errorCallback)
                [functionName].apply(null, args);
        }

        /**
         * Displays a transient alert message.
         * @param {string} elementId The ID of the alert div element.
         * @param {string} message The message to display.
         * @param {boolean} isSuccess True for success (green), false for error (red).
         */
        function showAlert(elementId, message, isSuccess) {
            const alertElement = document.getElementById(elementId);
            if (alertElement) {
                alertElement.textContent = message;
                alertElement.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'}`;
                alertElement.classList.add('active');
                setTimeout(() => {
                    alertElement.classList.remove('active');
                    setTimeout(() => { alertElement.style.display = 'none'; }, 300);
                }, 5000);
                alertElement.style.display = 'flex';
            }
        }

        /**
         * Opens a modal.
         * @param {string} modalId The ID of the modal to open.
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        /**
         * Closes a modal.
         * @param {string} modalId The ID of the modal to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const alertElement = document.getElementById(`${modalId.replace('Modal', '')}-alert`);
            if (alertElement) {
                alertElement.classList.remove('active');
                alertElement.style.display = 'none';
            }
        }

        /**
         * Formats a number as Indian Rupee currency.
         * @param {number} amount The numeric amount to format.
         * @returns {string} The formatted currency string (e.g., "₹1,23,456.78").
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        // --- Admin Actions ---

        function refreshDashboard() {
            loadDashboardStats();
            loadUsers();
            loadProducts();
            loadAnnouncements();
            loadRechargeRequests();
            loadPurchaseRequests();
            showAlert('user-list-alert', 'Dashboard data refreshed!', true);
        }

        function logoutAdmin() {
            if (confirm("Are you sure you want to log out?")) {
                window.top.location.href = 'index.html';
            }
        }

        // --- Tab Switching Logic ---

        /**
         * Switches between tabs in the admin panel.
         * @param {Event} evt The click event.
         * @param {string} tabName The ID of the tab content to show.
         */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;

            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }

            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            if (tabName !== 'Chat') {
                stopChatRefresh();
                currentChatUserEmail = null;
                document.getElementById('chat-header').innerHTML = '<i class="fas fa-user"></i> Select a user to start chatting';
                document.getElementById('chat-messages').innerHTML = '';
                document.getElementById('chat-input').disabled = true;
                document.getElementById('send-chat-btn').disabled = true;
            } else {
                loadChatUsers();
                if (currentChatUserEmail) {
                    selectChatUser(currentChatUserEmail);
                }
            }

            if (tabName === 'Dashboard') {
                loadDashboardStats();
            } else if (tabName === 'Users') {
                loadUsers();
            } else if (tabName === 'Products') {
                loadProducts();
            } else if (tabName === 'Announcements') {
                loadAnnouncements();
            } else if (tabName === 'Requests') {
                loadRechargeRequests();
                loadPurchaseRequests();
            }
        }

        // --- User Management ---
        function loadUsers() {
            callAppsScript(
                'getAllUsers',
                [],
                function(users) {
                    const tbody = document.getElementById('user-table-body');
                    tbody.innerHTML = '';
                    
                    if (users && users.length > 0) {
                        users.forEach(user => {
                            user.isActive = String(user.isActive).toLowerCase() === 'true';
                            user.pending = String(user.pending).toLowerCase() === 'true';

                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = user.id;
                            row.insertCell(1).textContent = user.name;
                            row.insertCell(2).textContent = user.email;
                            row.insertCell(3).textContent = formatCurrency(parseFloat(user.balance) || 0);

                            const statusCell = row.insertCell(4);
                            const isActiveBadge = document.createElement('span');
                            isActiveBadge.textContent = user.isActive ? 'Active' : 'Inactive';
                            isActiveBadge.className = `badge ${user.isActive ? 'badge-approved' : 'badge-rejected'}`;
                            statusCell.appendChild(isActiveBadge);

                            if (user.pending) {
                                const pendingBadge = document.createElement('span');
                                pendingBadge.textContent = ' Pending';
                                pendingBadge.className = 'badge badge-pending';
                                statusCell.appendChild(document.createTextNode(' '));
                                statusCell.appendChild(pendingBadge);
                            }
                            
                            row.insertCell(5).textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';

                            const actionsCell = row.insertCell(6);
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'btn-group';

                            const editBtn = document.createElement('button');
                            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                            editBtn.className = 'btn btn-sm btn-outline';
                            editBtn.title = 'Edit User';
                            editBtn.onclick = () => openEditUserModal(user);
                            btnGroup.appendChild(editBtn);

                            const toggleStatusBtn = document.createElement('button');
                            toggleStatusBtn.innerHTML = user.isActive ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check-circle"></i>';
                            toggleStatusBtn.className = `btn btn-sm ${user.isActive ? 'btn-danger' : 'btn-success'}`;
                            toggleStatusBtn.title = user.isActive ? 'Deactivate User' : 'Activate User';
                            toggleStatusBtn.onclick = () => handleToggleUserStatus(user.email, !user.isActive);
                            btnGroup.appendChild(toggleStatusBtn);

                            if (user.pending) {
                                const markDoneBtn = document.createElement('button');
                                markDoneBtn.innerHTML = '<i class="fas fa-user-check"></i>';
                                markDoneBtn.className = 'btn btn-sm btn-success';
                                markDoneBtn.title = 'Mark Done (Not Pending)';
                                markDoneBtn.onclick = () => handleMarkUserDone(user.email);
                                btnGroup.appendChild(markDoneBtn);
                            } else {
                                const markPendingBtn = document.createElement('button');
                                markPendingBtn.innerHTML = '<i class="fas fa-user-clock"></i>';
                                markPendingBtn.className = 'btn btn-sm btn-warning';
                                markPendingBtn.title = 'Mark Pending';
                                markPendingBtn.onclick = () => handleMarkUserPending(user.email);
                                btnGroup.appendChild(markPendingBtn);
                            }

                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.title = 'Delete User';
                            deleteBtn.onclick = () => handleDeleteUser(user.email);
                            btnGroup.appendChild(deleteBtn);

                            actionsCell.appendChild(btnGroup);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found.</td></tr>';
                    }
                    showAlert('user-list-alert', 'Users loaded successfully.', true);
                },
                function(error) {
                    console.error('Error loading users:', error);
                    document.getElementById('user-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Error loading users.</td></tr>';
                    showAlert('user-list-alert', 'Error loading users: ' + error.message, false);
                }
            );
        }

        function openAddUserModal() {
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
            showAlert('add-user-alert', '', true);
            openModal('addUserModal');
        }

        function handleAddUser() {
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;

            if (!name || !email || !password) {
                showAlert('add-user-alert', 'Please fill in all fields.', false);
                return;
            }

            callAppsScript(
                'adminAddUser',
                [name, email, password],
                function(response) {
                    if (response.success) {
                        showAlert('add-user-alert', response.message, true);
                        loadUsers();
                        loadDashboardStats();
                        setTimeout(() => closeModal('addUserModal'), 1500);
                    } else {
                        showAlert('add-user-alert', response.message, false);
                        console.error('Add user error:', response.message);
                    }
                },
                function(error) {
                    showAlert('add-user-alert', 'Error adding user: ' + error.message, false);
                    console.error('Add user RPC error:', error);
                }
            );
        }

        function handleDeleteUser(email) {
            if (confirm(`Are you sure you want to delete user ${email}? This action cannot be undone.`)) {
                callAppsScript(
                    'adminDeleteUser',
                    [email],
                    function(response) {
                        if (response.success) {
                            showAlert('user-list-alert', response.message, true);
                            loadUsers();
                            loadDashboardStats();
                        } else {
                            showAlert('user-list-alert', response.message, false);
                            console.error('Delete user error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('user-list-alert', 'Error deleting user: ' + error.message, false);
                        console.error('Delete user RPC error:', error);
                    }
                );
            }
        }

        function handleToggleUserStatus(email, newStatus) {
            if (confirm(`Are you sure you want to set ${email} to ${newStatus ? 'active' : 'inactive'} status?`)) {
                callAppsScript(
                    'toggleUserStatus',
                    [email, newStatus],
                    function(response) {
                        if (response.success) {
                            showAlert('user-list-alert', response.message, true);
                            loadUsers();
                            loadDashboardStats();
                        } else {
                            showAlert('user-list-alert', response.message, false);
                            console.error('Toggle status error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('user-list-alert', 'Error toggling user status: ' + error.message, false);
                        console.error('Toggle status RPC error:', error);
                    }
                );
            }
        }

        function handleMarkUserPending(email) {
            if (confirm(`Are you sure you want to mark user ${email} as pending?`)) {
                callAppsScript(
                    'markAsPending',
                    [email],
                    function(response) {
                        if (response.success) {
                            showAlert('user-list-alert', response.message, true);
                            loadUsers();
                            loadDashboardStats();
                        } else {
                            showAlert('user-list-alert', response.message, false);
                            console.error('Mark pending error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('user-list-alert', 'Error marking user pending: ' + error.message, false);
                        console.error('Mark pending RPC error:', error);
                    }
                );
            }
        }

        function handleMarkUserDone(email) {
            if (confirm(`Are you sure you want to mark user ${email} as done (no longer pending)?`)) {
                callAppsScript(
                    'markAsDone',
                    [email],
                    function(response) {
                        if (response.success) {
                            showAlert('user-list-alert', response.message, true);
                            loadUsers();
                            loadDashboardStats();
                        } else {
                            showAlert('user-list-alert', response.message, false);
                            console.error('Mark done error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('user-list-alert', 'Error marking user done: ' + error.message, false);
                        console.error('Mark done RPC error:', error);
                    }
                );
            }
        }

        function openEditUserModal(user) {
            document.getElementById('edit-user-original-email').value = user.email;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-balance').value = parseFloat(user.balance);
            document.getElementById('edit-user-is-active').value = String(user.isActive);
            document.getElementById('edit-user-pending').value = String(user.pending);
            document.getElementById('edit-user-notes').value = user.notes || '';

            showAlert('edit-user-alert', '', true);
            openModal('editUserModal');
        }

        function handleUpdateUser() {
            const originalEmail = document.getElementById('edit-user-original-email').value;
            const name = document.getElementById('edit-user-name').value;
            const balance = parseFloat(document.getElementById('edit-user-balance').value);
            const isActive = document.getElementById('edit-user-is-active').value === 'true';
            const pending = document.getElementById('edit-user-pending').value === 'true';
            const notes = document.getElementById('edit-user-notes').value;

            if (!name || isNaN(balance)) {
                showAlert('edit-user-alert', 'Please fill in name and a valid balance.', false);
                return;
            }

            const updatedUserData = {
                email: originalEmail,
                name: name,
                balance: balance,
                isActive: isActive,
                pending: pending,
                notes: notes
            };

            callAppsScript(
                'updateUserDetails',
                [updatedUserData],
                function(response) {
                    if (response.success) {
                        showAlert('edit-user-alert', response.message, true);
                        loadUsers();
                        loadDashboardStats();
                        setTimeout(() => closeModal('editUserModal'), 1500);
                    } else {
                        showAlert('edit-user-alert', response.message, false);
                        console.error('Update user error:', response.message);
                    }
                },
                function(error) {
                    showAlert('edit-user-alert', 'Error updating user: ' + error.message, false);
                    console.error('Update user RPC error:', error);
                }
            );
        }

        // --- Product Management ---
        function loadProducts() {
            callAppsScript(
                'getAllProducts',
                [],
                function(products) {
                    const tbody = document.getElementById('product-table-body');
                    tbody.innerHTML = '';

                    if (products && products.length > 0) {
                        products.forEach(product => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = product.id;
                            row.insertCell(1).textContent = product.name;
                            row.insertCell(2).textContent = product.category || 'N/A';
                            row.insertCell(3).textContent = formatCurrency(parseFloat(product.price) || 0);
                            row.insertCell(4).textContent = product.stock === -1 ? 'Unlimited' : product.stock;
                            
                            const statusCell = row.insertCell(5);
                            const stockStatus = product.stock === 0 ? 'Out of Stock' : 'In Stock';
                            const badgeClass = product.stock === 0 ? 'badge-rejected' : 'badge-approved';
                            const stockBadge = document.createElement('span');
                            stockBadge.textContent = stockStatus;
                            stockBadge.className = `badge ${badgeClass}`;
                            statusCell.appendChild(stockBadge);

                            const actionsCell = row.insertCell(6);
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'btn-group';

                            const editBtn = document.createElement('button');
                            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                            editBtn.className = 'btn btn-sm btn-outline';
                            editBtn.title = 'Edit Product';
                            editBtn.onclick = () => openEditProductModal(product);
                            btnGroup.appendChild(editBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.title = 'Delete Product';
                            deleteBtn.onclick = () => handleDeleteProduct(product.id);
                            btnGroup.appendChild(deleteBtn);

                            actionsCell.appendChild(btnGroup);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No products found.</td></tr>';
                    }
                    showAlert('product-list-alert', 'Products loaded successfully.', true);
                },
                function(error) {
                    console.error('Error loading products:', error);
                    document.getElementById('product-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Error loading products.</td></tr>';
                    showAlert('product-list-alert', 'Error loading products: ' + error.message, false);
                }
            );
        }

        function openAddProductModal() {
            document.getElementById('product-name').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('product-price').value = '0.00';
            document.getElementById('product-discount-price').value = '';
            document.getElementById('product-image-url').value = '';
            document.getElementById('product-rating').value = '0';
            document.getElementById('product-tags').value = '';
            document.getElementById('product-category').value = '';
            document.getElementById('product-stock').value = '0';
            showAlert('add-product-alert', '', true);
            openModal('addProductModal');
        }

        function handleAddProduct() {
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: document.getElementById('product-price').value,
                discountPrice: document.getElementById('product-discount-price').value || null,
                imageUrl: document.getElementById('product-image-url').value,
                rating: document.getElementById('product-rating').value,
                tags: document.getElementById('product-tags').value,
                category: document.getElementById('product-category').value,
                stock: document.getElementById('product-stock').value
            };

            if (!productData.name || !productData.price || isNaN(parseFloat(productData.price))) {
                showAlert('add-product-alert', 'Please fill in product name and a valid price.', false);
                return;
            }

            callAppsScript(
                'addProduct',
                [productData],
                function(response) {
                    if (response.success) {
                        showAlert('add-product-alert', response.message, true);
                        loadProducts();
                        setTimeout(() => closeModal('addProductModal'), 1500);
                    } else {
                        showAlert('add-product-alert', response.message, false);
                        console.error('Add product error:', response.message);
                    }
                },
                function(error) {
                    showAlert('add-product-alert', 'Error adding product: ' + error.message, false);
                    console.error('Add product RPC error:', error);
                }
            );
        }

        function handleDeleteProduct(productId) {
            if (confirm(`Are you sure you want to delete product ID: ${productId}? This action cannot be undone.`)) {
                callAppsScript(
                    'deleteProduct',
                    [productId],
                    function(response) {
                        if (response.success) {
                            showAlert('product-list-alert', response.message, true);
                            loadProducts();
                        } else {
                            showAlert('product-list-alert', response.message, false);
                            console.error('Delete product error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('product-list-alert', 'Error deleting product: ' + error.message, false);
                        console.error('Delete product RPC error:', error);
                    }
                );
            }
        }

        function openEditProductModal(product) {
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-description').value = product.description;
            document.getElementById('edit-product-price').value = parseFloat(product.price);
            document.getElementById('edit-product-discount-price').value = product.discountPrice !== null ? parseFloat(product.discountPrice) : '';
            document.getElementById('edit-product-image-url').value = product.imageUrl;
            document.getElementById('edit-product-rating').value = parseFloat(product.rating);
            document.getElementById('edit-product-tags').value = Array.isArray(product.tags) ? product.tags.join(', ') : product.tags;
            document.getElementById('edit-product-category').value = product.category;
            document.getElementById('edit-product-stock').value = parseInt(product.stock);

            showAlert('edit-product-alert', '', true);
            openModal('editProductModal');
        }

        function handleUpdateProduct() {
            const updatedProductData = {
                id: parseInt(document.getElementById('edit-product-id').value),
                name: document.getElementById('edit-product-name').value,
                description: document.getElementById('edit-product-description').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                discountPrice: document.getElementById('edit-product-discount-price').value ? parseFloat(document.getElementById('edit-product-discount-price').value) : null,
                imageUrl: document.getElementById('edit-product-image-url').value,
                rating: parseFloat(document.getElementById('edit-product-rating').value),
                tags: document.getElementById('edit-product-tags').value.split(',').map(tag => tag.trim()),
                category: document.getElementById('edit-product-category').value,
                stock: parseInt(document.getElementById('edit-product-stock').value)
            };

            if (!updatedProductData.name || isNaN(updatedProductData.price)) {
                showAlert('edit-product-alert', 'Please fill in product name and a valid price.', false);
                return;
            }

            callAppsScript(
                'updateProduct',
                [updatedProductData],
                function(response) {
                    if (response.success) {
                        showAlert('edit-product-alert', response.message, true);
                        loadProducts();
                        setTimeout(() => closeModal('editProductModal'), 1500);
                    } else {
                        showAlert('edit-product-alert', response.message, false);
                        console.error('Update product error:', response.message);
                    }
                },
                function(error) {
                    showAlert('edit-product-alert', 'Error updating product: ' + error.message, false);
                    console.error('Update product RPC error:', error);
                }
            );
        }

        // --- Announcement Management ---
        function loadAnnouncements() {
            callAppsScript(
                'getAllAnnouncements',
                [],
                function(response) {
                    const tbody = document.getElementById('announcement-table-body');
                    tbody.innerHTML = '';

                    if (response.success && response.announcements && response.announcements.length > 0) {
                        response.announcements.forEach(announcement => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = announcement.id;
                            row.insertCell(1).textContent = announcement.title;
                            row.insertCell(2).textContent = announcement.content;
                            row.insertCell(3).textContent = announcement.createdAt ? new Date(announcement.createdAt).toLocaleDateString() : 'N/A';

                            const actionsCell = row.insertCell(4);
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'btn-group';

                            const editBtn = document.createElement('button');
                            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                            editBtn.className = 'btn btn-sm btn-outline';
                            editBtn.title = 'Edit Announcement';
                            editBtn.onclick = () => openEditAnnouncementModal(announcement);
                            btnGroup.appendChild(editBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.title = 'Delete Announcement';
                            deleteBtn.onclick = () => handleDeleteAnnouncement(announcement.id);
                            btnGroup.appendChild(deleteBtn);

                            actionsCell.appendChild(btnGroup);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No announcements found.</td></tr>';
                    }
                    showAlert('announcement-list-alert', 'Announcements loaded successfully.', true);
                },
                function(error) {
                    console.error('Error loading announcements:', error);
                    document.getElementById('announcement-table-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--danger);">Error loading announcements.</td></tr>';
                    showAlert('announcement-list-alert', 'Error loading announcements: ' + error.message, false);
                }
            );
        }

        function openAddAnnouncementModal() {
            document.getElementById('announcement-title').value = '';
            document.getElementById('announcement-content').value = '';
            showAlert('add-announcement-alert', '', true);
            openModal('addAnnouncementModal');
        }

        function handleAddAnnouncement() {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;

            if (!title || !content) {
                showAlert('add-announcement-alert', 'Please fill in both title and content.', false);
                return;
            }

            const announcementData = {
                title: title,
                content: content
            };

            callAppsScript(
                'addAnnouncement',
                [announcementData],
                function(response) {
                    if (response.success) {
                        showAlert('add-announcement-alert', response.message, true);
                        loadAnnouncements();
                        setTimeout(() => closeModal('addAnnouncementModal'), 1500);
                    } else {
                        showAlert('add-announcement-alert', response.message, false);
                        console.error('Add announcement error:', response.message);
                    }
                },
                function(error) {
                    showAlert('add-announcement-alert', 'Error adding announcement: ' + error.message, false);
                    console.error('Add announcement error:', error);
                }
            );
        }

        function openEditAnnouncementModal(announcement) {
            document.getElementById('edit-announcement-id').value = announcement.id;
            document.getElementById('edit-announcement-title').value = announcement.title;
            document.getElementById('edit-announcement-content').value = announcement.content;

            showAlert('edit-announcement-alert', '', true);
            openModal('editAnnouncementModal');
        }

        function handleUpdateAnnouncement() {
            const updatedAnnouncementData = {
                id: parseInt(document.getElementById('edit-announcement-id').value),
                title: document.getElementById('edit-announcement-title').value,
                content: document.getElementById('edit-announcement-content').value
            };

            if (!updatedAnnouncementData.title || !updatedAnnouncementData.content) {
                showAlert('edit-announcement-alert', 'Please fill in both title and content.', false);
                return;
            }

            callAppsScript(
                'updateAnnouncement',
                [updatedAnnouncementData],
                function(response) {
                    if (response.success) {
                        showAlert('edit-announcement-alert', response.message, true);
                        loadAnnouncements();
                        setTimeout(() => closeModal('editAnnouncementModal'), 1500);
                    } else {
                        showAlert('edit-announcement-alert', response.message, false);
                        console.error('Update announcement error:', response.message);
                    }
                },
                function(error) {
                    showAlert('edit-announcement-alert', 'Error updating announcement: ' + error.message, false);
                    console.error('Update announcement error:', error);
                }
            );
        }

        function handleDeleteAnnouncement(announcementId) {
            if (confirm(`Are you sure you want to delete announcement ID: ${announcementId}? This action cannot be undone.`)) {
                callAppsScript(
                    'deleteAnnouncement',
                    [announcementId],
                    function(response) {
                        if (response.success) {
                            showAlert('announcement-list-alert', response.message, true);
                            loadAnnouncements();
                        } else {
                            showAlert('announcement-list-alert', response.message, false);
                            console.error('Delete announcement error:', response.message);
                        }
                    },
                    function(error) {
                        showAlert('announcement-list-alert', 'Error deleting announcement: ' + error.message, false);
                        console.error('Delete announcement error:', error);
                    }
                );
            }
        }

        // --- Recharge Request Management ---
        function loadRechargeRequests() {
            callAppsScript(
                'getPendingRechargeRequests',
                [],
                function(response) {
                    const tbody = document.getElementById('recharge-requests-table-body');
                    tbody.innerHTML = '';

                    if (response.success && response.requests && response.requests.length > 0) {
                        response.requests.forEach(request => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = request.id;
                            row.insertCell(1).textContent = request.userEmail;
                            row.insertCell(2).textContent = formatCurrency(parseFloat(request.amount || 0));
                            row.insertCell(3).textContent = request.transactionId;
                            const screenshotCell = row.insertCell(4);
                            if (request.screenshotUrl) {
                                const link = document.createElement('a');
                                link.href = request.screenshotUrl;
                                link.target = '_blank';
                                link.textContent = 'View';
                                link.className = 'btn btn-sm btn-outline';
                                link.title = 'View Screenshot';
                                screenshotCell.appendChild(link);
                            } else {
                                screenshotCell.textContent = 'N/A';
                            }
                            row.insertCell(5).textContent = request.requestDate ? new Date(request.requestDate).toLocaleDateString() : 'N/A';
                            
                            const statusCell = row.insertCell(6);
                            const statusBadge = document.createElement('span');
                            statusBadge.textContent = request.status;
                            statusBadge.className = `badge badge-${request.status.toLowerCase()}`;
                            statusCell.appendChild(statusBadge);

                            const actionsCell = row.insertCell(7);
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'btn-group';

                            if (request.status === 'Pending') {
                                const approveBtn = document.createElement('button');
                                approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                                approveBtn.className = 'btn btn-sm btn-success';
                                approveBtn.title = 'Approve Recharge';
                                approveBtn.onclick = () => showAdminNotesModal('recharge', request.id, 'approve');
                                btnGroup.appendChild(approveBtn);

                                const rejectBtn = document.createElement('button');
                                rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
                                rejectBtn.className = 'btn btn-sm btn-danger';
                                rejectBtn.title = 'Reject Recharge';
                                rejectBtn.onclick = () => showAdminNotesModal('recharge', request.id, 'reject');
                                btnGroup.appendChild(rejectBtn);
                            } else {
                                const viewBtn = document.createElement('button');
                                viewBtn.innerHTML = '<i class="fas fa-eye"></i> View';
                                viewBtn.className = 'btn btn-sm btn-outline';
                                viewBtn.title = 'View Details';
                                viewBtn.onclick = () => showAlert('recharge-requests-alert', `Notes: ${request.adminNotes || 'No notes.'}`, true);
                                btnGroup.appendChild(viewBtn);
                            }
                            actionsCell.appendChild(btnGroup);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No recharge requests found.</td></tr>';
                    }
                    showAlert('recharge-requests-alert', 'Recharge requests loaded successfully.', true);
                },
                function(error) {
                    console.error('Error loading recharge requests:', error);
                    document.getElementById('recharge-requests-table-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger);">Error loading recharge requests.</td></tr>';
                    showAlert('recharge-requests-alert', 'Error loading recharge requests: ' + error.message, false);
                }
            );
        }

        // --- Purchase Request Management ---
        function loadPurchaseRequests() {
            callAppsScript(
                'getPurchaseRequests',
                [],
                function(response) {
                    const tbody = document.getElementById('purchase-requests-table-body');
                    tbody.innerHTML = '';

                    if (response.success && response.requests && response.requests.length > 0) {
                        response.requests.forEach(request => {
                            const row = tbody.insertRow();
                            row.insertCell(0).textContent = request.id;
                            row.insertCell(1).textContent = request.userEmail;
                            row.insertCell(2).textContent = request.productName;
                            row.insertCell(3).textContent = formatCurrency(parseFloat(request.productPrice || 0));
                            row.insertCell(4).textContent = request.requestDate ? new Date(request.requestDate).toLocaleDateString() : 'N/A';
                            
                            const statusCell = row.insertCell(5);
                            const statusBadge = document.createElement('span');
                            statusBadge.textContent = request.status;
                            statusBadge.className = `badge badge-${request.status.toLowerCase()}`;
                            statusCell.appendChild(statusBadge);

                            const actionsCell = row.insertCell(6);
                            const btnGroup = document.createElement('div');
                            btnGroup.className = 'btn-group';

                            if (request.status === 'Pending') {
                                const approveBtn = document.createElement('button');
                                approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                                approveBtn.className = 'btn btn-sm btn-success';
                                approveBtn.title = 'Approve Purchase';
                                approveBtn.onclick = () => showAdminNotesModal('purchase', request.id, 'approve');
                                btnGroup.appendChild(approveBtn);

                                const rejectBtn = document.createElement('button');
                                rejectBtn.innerHTML = '<i class="fas fa-times"></i> Reject';
                                rejectBtn.className = 'btn btn-sm btn-danger';
                                rejectBtn.title = 'Reject Purchase';
                                rejectBtn.onclick = () => showAdminNotesModal('purchase', request.id, 'reject');
                                btnGroup.appendChild(rejectBtn);
                            } else {
                                const viewBtn = document.createElement('button');
                                viewBtn.innerHTML = '<i class="fas fa-eye"></i> View';
                                viewBtn.className = 'btn btn-sm btn-outline';
                                viewBtn.title = 'View Details';
                                viewBtn.onclick = () => showAlert('purchase-requests-alert', `Notes: ${request.adminNotes || 'No notes.'}`, true);
                                btnGroup.appendChild(viewBtn);
                            }
                            actionsCell.appendChild(btnGroup);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No purchase requests found.</td></tr>';
                    }
                    showAlert('purchase-requests-alert', 'Purchase requests loaded successfully.', true);
                },
                function(error) {
                    console.error('Error loading purchase requests:', error);
                    document.getElementById('purchase-requests-table-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Error loading purchase requests.</td></tr>';
                    showAlert('purchase-requests-alert', 'Error loading purchase requests: ' + error.message, false);
                }
            );
        }

        // --- Admin Notes Modal for Request Approval/Rejection ---
        let currentRequestType = '';
        let currentRequestId = null;
        let currentRequestAction = '';

        function showAdminNotesModal(type, id, action) {
            currentRequestType = type;
            currentRequestId = id;
            currentRequestAction = action;

            const title = document.getElementById('notes-modal-title');
            title.textContent = `Add Notes for ${type.charAt(0).toUpperCase() + type.slice(1)} Request ID: ${id} (${action.charAt(0).toUpperCase() + action.slice(1)})`;
            document.getElementById('admin-notes-textarea').value = '';
            showAlert('admin-notes-alert', '', true);
            openModal('adminNotesModal');
        }

        function submitAdminNotes() {
            const notes = document.getElementById('admin-notes-textarea').value;
            
            if (currentRequestType === 'recharge') {
                if (currentRequestAction === 'approve') {
                    handleApproveRechargeRequest(currentRequestId, notes);
                } else if (currentRequestAction === 'reject') {
                    handleRejectRechargeRequest(currentRequestId, notes);
                }
            } else if (currentRequestType === 'purchase') {
                if (currentRequestAction === 'approve') {
                    handleApprovePurchaseRequest(currentRequestId, notes);
                } else if (currentRequestAction === 'reject') {
                    handleRejectPurchaseRequest(currentRequestId, notes);
                }
            }
            closeModal('adminNotesModal');
            currentRequestType = '';
            currentRequestId = null;
            currentRequestAction = '';
        }

        function handleApproveRechargeRequest(requestId, notes) {
            callAppsScript(
                'approveRechargeRequest',
                [requestId, ADMIN_EMAIL, notes],
                function(response) {
                    if (response.success) {
                        showAlert('recharge-requests-alert', response.message, true);
                        loadRechargeRequests();
                        loadUsers();
                        loadDashboardStats();
                    } else {
                        showAlert('recharge-requests-alert', response.message, false);
                        console.error('Approve recharge error:', response.message);
                    }
                },
                function(error) {
                    showAlert('recharge-requests-alert', 'Error approving recharge request: ' + error.message, false);
                    console.error('Approve recharge RPC error:', error);
                }
            );
        }

        function handleRejectRechargeRequest(requestId, notes) {
            callAppsScript(
                'rejectRechargeRequest',
                [requestId, ADMIN_EMAIL, notes],
                function(response) {
                    if (response.success) {
                        showAlert('recharge-requests-alert', response.message, true);
                        loadRechargeRequests();
                        loadDashboardStats();
                    } else {
                        showAlert('recharge-requests-alert', response.message, false);
                        console.error('Reject recharge error:', response.message);
                    }
                },
                function(error) {
                    showAlert('recharge-requests-alert', 'Error rejecting recharge request: ' + error.message, false);
                    console.error('Reject recharge RPC error:', error);
                }
            );
        }

        function handleApprovePurchaseRequest(requestId, notes) {
            callAppsScript(
                'approvePurchaseRequest',
                [requestId, ADMIN_EMAIL, notes],
                function(response) {
                    if (response.success) {
                        showAlert('purchase-requests-alert', response.message, true);
                        loadPurchaseRequests();
                        loadUsers();
                        loadProducts();
                        loadDashboardStats();
                    } else {
                        showAlert('purchase-requests-alert', response.message, false);
                        console.error('Approve purchase error:', response.message);
                    }
                },
                function(error) {
                    showAlert('purchase-requests-alert', 'Error approving purchase request: ' + error.message, false);
                    console.error('Approve purchase RPC error:', error);
                }
            );
        }

        function handleRejectPurchaseRequest(requestId, notes) {
            callAppsScript(
                'rejectPurchaseRequest',
                [requestId, ADMIN_EMAIL, notes],
                function(response) {
                    if (response.success) {
                        showAlert('purchase-requests-alert', response.message, true);
                        loadPurchaseRequests();
                        loadDashboardStats();
                    } else {
                        showAlert('purchase-requests-alert', response.message, false);
                        console.error('Reject purchase error:', response.message);
                    }
                },
                function(error) {
                    showAlert('purchase-requests-alert', 'Error rejecting purchase request: ' + error.message, false);
                    console.error('Reject purchase RPC error:', error);
                }
            );
        }

        // --- Chat Logic ---
        function loadChatUsers() {
            callAppsScript(
                'getUsersWithChatHistory',
                [ADMIN_EMAIL],
                function(response) {
                    const userListDiv = document.getElementById('chat-user-list');
                    userListDiv.innerHTML = '';
                    if (response.success && response.users && response.users.length > 0) {
                        response.users.sort((a, b) => a.localeCompare(b));

                        response.users.forEach(userEmail => {
                            const userItem = document.createElement('div');
                            userItem.className = 'chat-user';
                            userItem.onclick = () => selectChatUser(userEmail);
                            
                            const avatar = document.createElement('div');
                            avatar.className = 'chat-user-avatar';
                            avatar.textContent = userEmail.substring(0, 2).toUpperCase();

                            const userInfo = document.createElement('div');
                            userInfo.className = 'chat-user-info';
                            const userNameDiv = document.createElement('div');
                            userNameDiv.className = 'chat-user-name';
                            userNameDiv.textContent = userEmail.split('@')[0];
                            const userEmailDiv = document.createElement('div');
                            userEmailDiv.className = 'chat-user-email';
                            userEmailDiv.textContent = userEmail;

                            userInfo.appendChild(userNameDiv);
                            userInfo.appendChild(userEmailDiv);
                            userItem.appendChild(avatar);
                            userItem.appendChild(userInfo);
                            userListDiv.appendChild(userItem);
                        });
                        if (currentChatUserEmail) {
                            const selectedItem = Array.from(userListDiv.children).find(item => {
                                const emailDiv = item.querySelector('.chat-user-email');
                                return emailDiv && emailDiv.textContent.trim() === currentChatUserEmail;
                            });
                            if (selectedItem) selectedItem.classList.add('active');
                        }
                    } else {
                        userListDiv.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--gray);">No chat history found.</p>';
                    }
                },
                function(error) {
                    showAlert('chat-alert', 'Error loading chat users: ' + error.message, false);
                    console.error('Error loading chat users:', error);
                }
            );
        }

        function selectChatUser(userEmail) {
            currentChatUserEmail = userEmail;
            document.getElementById('chat-header').innerHTML = `<i class="fas fa-user"></i> Chat with ${userEmail.split('@')[0]}`;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-chat-btn').disabled = false;

            const userItems = document.querySelectorAll('#chat-user-list .chat-user');
            for (let item of userItems) {
                item.classList.remove('active');
                const emailDiv = item.querySelector('.chat-user-email');
                if (emailDiv && emailDiv.textContent.trim() === userEmail) {
                    item.classList.add('active');
                }
            }

            loadChatHistory(userEmail);
            startChatRefresh(userEmail);
            showAlert('chat-alert', '', true);
        }

        function loadChatHistory(userEmail) {
            if (!userEmail) return;

            callAppsScript(
                'getChatHistory',
                [userEmail, ADMIN_EMAIL],
                function(response) {
                    const messagesDiv = document.getElementById('chat-messages');
                    const isScrolledToBottom = messagesDiv.scrollHeight - messagesDiv.clientHeight <= messagesDiv.scrollTop + 1;

                    messagesDiv.innerHTML = '';
                    if (response.success && response.chatHistory && response.chatHistory.length > 0) {
                        response.chatHistory.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            const isUserMessage = msg.senderEmail === userEmail;
                            msgDiv.className = `chat-message ${isUserMessage ? 'chat-message-user' : 'chat-message-admin'}`;
                            
                            msgDiv.innerHTML = `
                                ${msg.messageContent}
                                <div class="chat-message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                            `;
                            messagesDiv.appendChild(msgDiv);
                        });
                        if (isScrolledToBottom || messagesDiv.scrollTop === 0) {
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    } else {
                        messagesDiv.innerHTML = '<p style="text-align: center; color: var(--gray);">No messages yet. Start a conversation!</p>';
                    }
                },
                function(error) {
                    showAlert('chat-alert', 'Error loading chat history: ' + error.message, false);
                    console.error('Error loading chat history:', error);
                }
            );
        }

        function sendAdminMessage() {
            const messageInput = document.getElementById('chat-input');
            const messageContent = messageInput.value.trim();

            if (!currentChatUserEmail || !messageContent) {
                showAlert('chat-alert', 'Please select a user and type a message.', false);
                return;
            }

            messageInput.value = '';

            callAppsScript(
                'sendMessage',
                [ADMIN_EMAIL, currentChatUserEmail, messageContent],
                function(response) {
                    if (response.success) {
                        loadChatHistory(currentChatUserEmail);
                    } else {
                        showAlert('chat-alert', response.message, false);
                        console.error('Error sending message:', response.message);
                    }
                },
                function(error) {
                    showAlert('chat-alert', 'Error sending message: ' + error.message, false);
                    console.error('Error sending message RPC:', error);
                }
            );
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendAdminMessage();
            }
        }

        function startChatRefresh(userEmail) {
            stopChatRefresh();
            chatRefreshIntervalId = setInterval(() => {
                if (userEmail) {
                    loadChatHistory(userEmail);
                }
            }, 5000);
        }

        function stopChatRefresh() {
            if (chatRefreshIntervalId) {
                clearInterval(chatRefreshIntervalId);
                chatRefreshIntervalId = null;
            }
        }

        // --- Initialize the page ---
        window.onload = function() {
            initTheme();
            
            document.querySelector('.tab-button').classList.add('active');
            document.getElementById('Dashboard').classList.add('active');
            
            loadDashboardStats();
            loadUsers();

            document.getElementById('admin-email').value = ADMIN_EMAIL;
        };

        // Auto-refresh intervals
        setInterval(() => {
            if (document.getElementById('Dashboard').classList.contains('active')) {
                loadDashboardStats();
            }
        }, 20000);

        setInterval(() => {
            if (document.getElementById('Users').classList.contains('active')) {
                loadUsers();
            }
        }, 20000);

        setInterval(() => {
            if (document.getElementById('Products').classList.contains('active')) {
                loadProducts();
            }
        }, 30000);

        setInterval(() => {
            if (document.getElementById('Announcements').classList.contains('active')) {
                loadAnnouncements();
            }
        }, 30000);

        setInterval(() => {
            if (document.getElementById('Requests').classList.contains('active')) {
                loadRechargeRequests();
                loadPurchaseRequests();
            }
        }, 20000);
    </script>
</body>
</html>